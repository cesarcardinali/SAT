package main;


import java.awt.Dimension;
import java.awt.EventQueue;
import java.awt.Toolkit;
import java.awt.event.WindowEvent;
import java.awt.event.WindowFocusListener;

import java.io.File;
import java.io.IOException;

import javax.swing.JFrame;
import javax.swing.JOptionPane;

import org.apache.commons.io.FileUtils;
import org.jdom2.JDOMException;

import core.Icons;
import core.Logger;
import core.SharedObjs;
import core.XmlMngr;
import core.Strings;


@SuppressWarnings("serial")
public class SAT extends JFrame{

	boolean updating = false;	// Checking for update
	
	/**
	 * Runnable
	 */
	public static void main(String[] args) {
		EventQueue.invokeLater(new Runnable() {
			public void run() {
				// Initialize all static classes
				XmlMngr.initClass();
				SharedObjs.initClass();
				Logger.initClass();
				
				// Start UI
				SharedObjs.satFrame.setVisible(true);
			}
		});
	}

	/**
	 * Configure application.
	 */
	public SAT() {
		//Initializing window
		setIconImage(Icons.iconSat);
		setTitle(Strings.getToolName() + " " + Strings.getToolVersion());
		setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		Dimension screenSize = Toolkit.getDefaultToolkit().getScreenSize();
		double width = screenSize.getWidth();
		double height = screenSize.getHeight();
		setBounds((int)(width/3), 0, (int)(width/1.5), (int)height-40);
		setVisible(true);
		setMinimumSize(new Dimension(800, 600));
		
		//Inserting the TabPane
		getContentPane().add(SharedObjs.tabbedPane);
		
		//Window Focus Listener
<<<<<<< Upstream, based on origin/Code_Revision_Cesar
		addWindowFocusListener(satWFL);
=======
		addWindowFocusListener(new WindowFocusListener() {
			@Override
			public void windowLostFocus(WindowEvent e) {
				Logger.log(Logger.TAG_SAT, "Window lost focus");
			}
			
			@Override
			public void windowGainedFocus(WindowEvent e) {
				Logger.log(Logger.TAG_SAT, "Window gained focus");
				SharedObjs.crsManagerPane.updateAllDataUI();
			}
		});
>>>>>>> 08d09cf Fixed BATTRIAGE-74 Put Logger along with System.out.print in all code long
		
		// Save configurations on close
<<<<<<< Upstream, based on origin/Code_Revision_Cesar
		Runtime.getRuntime().addShutdownHook(onShutdown);
=======
		Runtime.getRuntime().addShutdownHook(new Thread() {
			@Override
			public void run() {
				int run = 0;
				while(run == 0){
					try {
						//Abre o arquivo XML
						File xmlFile = SharedObjs.sytemCfgFile;
						
						//Cria o builder da estrutura XML
						SAXBuilder builder = new SAXBuilder();
						
						//Cria documento formatado de acordo com a lib XML
						Document document = (Document) builder.build(xmlFile);
						
						//Pega o n� raiz do XML
						Element satNode = document.getRootElement();
						
						//Gera lista de filhos do n� root
						//List<Element> satElements = satNode.getChildren();
						
						//Pega o n� referente ao option pane
						Element optionPaneNode = satNode.getChild("configs"); 
						for(Element e : optionPaneNode.getChildren()){
							if(e.getName().equals("update_path1")){
								e.setText(SharedObjs.updateFolder1);
								
							} else if(e.getName().equals("update_path2")){
								e.setText(SharedObjs.updateFolder2);
								
							}
						}
						
						//JDOM document is ready now, lets write it to file now
				        XMLOutputter xmlOutputter = new XMLOutputter(Format.getPrettyFormat());
				        //output xml to console for debugging
				        //xmlOutputter.output(doc, System.out);
				        xmlOutputter.output(document, new FileOutputStream(xmlFile));
						
						SharedObjs.crsManagerPane.saveUserData();
						SharedObjs.parserPane.savePaneData();
						SharedObjs.optionsPane.savePaneData();
						
						Logger.log(Logger.TAG_SAT, "All data saved");
						
						run = 1;
					} catch (JDOMException | IOException e1) {
						e1.printStackTrace();
						Logger.log(Logger.TAG_SAT, "finished3");
						run = 1;
					} finally{
						Logger.log(Logger.TAG_SAT, "finished1");
						run = 1;
					}
				}
				
				XmlMngr.closeXmls();
				Logger.close();
				
				if(SharedObjs.satFrame.getUpdating() == 0)
					SharedObjs.satFrame.checkForUpdate();
			}
		});
>>>>>>> 08d09cf Fixed BATTRIAGE-74 Put Logger along with System.out.print in all code long
		
		// Start updater thread
		updateThread();
	}
	
	/**
	 * Keep looking for new updates 
	 */
	private void updateThread(){
		new Thread(new Runnable() {
			int stop = 0;
			
			@Override
			public void run() {
				stop = checkForUpdate();
				while(stop == 0){
					try {
						Thread.sleep(900000); // Check for update each 15 minutes
					} catch (InterruptedException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					stop = checkForUpdate();
				}
				if(stop == 1){
					System.out.println("\n\nExiting");
					System.exit(0);
				}
			}
		}).start();
	}
	
	/**
	 * Check for newer version
	 */
	public int checkForUpdate(){
		updating = true;
		File f1;
		File f2;
		long dateRemote, dateLocal;
		
<<<<<<< Upstream, based on origin/Code_Revision_Cesar
		f1 = new File(SharedObjs.updateFolder1 + Strings.getToolFileName());
		System.out.println("Remote file: " + f1.getAbsolutePath());
		System.out.println("Remote: " + f1.lastModified());
		f2 = new File(Strings.getToolFileName());
		System.out.println("Local file: " + f2.getAbsolutePath());
		System.out.println("Local: " + f2.lastModified());
=======
		f1 = new File(SharedObjs.updateFolder1 + SharedObjs.toolFile);
		Logger.log(Logger.TAG_SAT, "Remote file: " + f1.getAbsolutePath());
		Logger.log(Logger.TAG_SAT, "Remote: " + f1.lastModified());
		f2 = new File(SharedObjs.toolFile);
		Logger.log(Logger.TAG_SAT, "Local file: " + f2.getAbsolutePath());
		Logger.log(Logger.TAG_SAT, "Local: " + f2.lastModified());
>>>>>>> 08d09cf Fixed BATTRIAGE-74 Put Logger along with System.out.print in all code long
		dateRemote = f1.lastModified();
		dateLocal = f2.lastModified();
		
		if(dateLocal < dateRemote && dateLocal != 0){
			Object[] options = new Object[]{ "Yes", "No" };
			int n = JOptionPane.showOptionDialog(null,
					"Uma nova vers�o foi encontrada. Voce desaja atualizar agora?",
					"New version available", JOptionPane.YES_NO_CANCEL_OPTION,
					JOptionPane.QUESTION_MESSAGE, null, options,
					options[1]);
			if(n == 0) {
				try {
<<<<<<< Upstream, based on origin/Code_Revision_Cesar
					System.out.println("Updating the Updater first, from: " + SharedObjs.updateFolder1);
					FileUtils.copyFile(new File(SharedObjs.updateFolder1 + "/" + Strings.getUpdaterFileName()), new File(Strings.getUpdaterFileName()));
=======
					Logger.log(Logger.TAG_SAT, "Updating the Updater first, from: " + SharedObjs.updateFolder1);
					FileUtils.copyFile(new File(SharedObjs.updateFolder1 + "/" + SharedObjs.updaterFile), new File(SharedObjs.updaterFile));
>>>>>>> 08d09cf Fixed BATTRIAGE-74 Put Logger along with System.out.print in all code long
				} catch (IOException e) {
					Logger.log(Logger.TAG_SAT, "Updating the Updater failed");
					e.printStackTrace();
				}
				Logger.log(Logger.TAG_SAT, "Updating");
				try {
<<<<<<< Upstream, based on origin/Code_Revision_Cesar
					System.out.println("path: " + new File("").getAbsolutePath());
					ProcessBuilder builder = new ProcessBuilder("cmd.exe", "/c", "cd " + new File("").getAbsolutePath() + " && java -jar " + Strings.getUpdaterFileName());
=======
					Logger.log(Logger.TAG_SAT, "path: " + new File("").getAbsolutePath());
					ProcessBuilder builder = new ProcessBuilder("cmd.exe", "/c", "cd " + new File("").getAbsolutePath() + " && java -jar " + SharedObjs.updaterFile);
>>>>>>> 08d09cf Fixed BATTRIAGE-74 Put Logger along with System.out.print in all code long
					builder.start();
				} catch (IOException e2) {
					e2.printStackTrace();
				}
				return 1;
			} else {
				return 2;
			}
		}
		return 0;
	}
	
	/**
	 * Thread to run when shutting down SAT application
	 */
<<<<<<< Upstream, based on origin/Code_Revision_Cesar
	Thread onShutdown = new Thread(new Runnable() {
		@Override
		public void run() {
			int run = 0;
			while(run == 0){
				try {
					SharedObjs.crsManagerPane.saveUserData();
					SharedObjs.parserPane.savePaneData();
					SharedObjs.optionsPane.savePaneData();
					
					run = 1;
				} catch (JDOMException | IOException e1) {
					e1.printStackTrace();
					System.out.println("finished3");
					run = 1;
				} finally{
					System.out.println("finished1");
					run = 1;
=======
	private void updateThread(){
		new Thread(new Runnable() {
			int stop = 0;
			
			@Override
			public void run() {
				stop = checkForUpdate();
				while(stop == 0){
					try {
						Thread.sleep(900000);
						//Thread.sleep(3000);
					} catch (InterruptedException e) {
						// TODO Auto-generated catch block
						e.printStackTrace();
					}
					stop = checkForUpdate();
				}
				if(stop == 1){
					Logger.log(Logger.TAG_SAT, "\n\nExiting");
					System.exit(0);
>>>>>>> 08d09cf Fixed BATTRIAGE-74 Put Logger along with System.out.print in all code long
				}
			}
			
			XmlMngr.closeXmls();
			Logger.close();
		}
	});
	
	/**
	 * Window Focus Listener used on SAT main Frame
	 */
	WindowFocusListener satWFL = new WindowFocusListener() {
		@Override
		public void windowLostFocus(WindowEvent e) {
			System.out.println("Window focus lost");
		}
		
		@Override
		public void windowGainedFocus(WindowEvent e) {
			System.out.println("Window focus gained ");
			SharedObjs.crsManagerPane.updateAllDataUI();
		}
	};

	/**
	 * Getters and Setters:
	 */
	public boolean isUpdating(){
		return updating;
	}
	
	public void setUpdating(boolean is){
		updating = is;
	}
}
